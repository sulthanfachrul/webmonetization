(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{64:function(e,t,r){"use strict";r.r(t),r.d(t,"frontMatter",(function(){return o})),r.d(t,"metadata",(function(){return c})),r.d(t,"rightToc",(function(){return p})),r.d(t,"default",(function(){return l}));var i=r(2),n=r(6),a=(r(0),r(92)),o={id:"receipt-verifier",title:"Receipt Verifier Service",sidebar_label:"Receipt verifier service"},c={unversionedId:"receipt-verifier",id:"receipt-verifier",isDocsHomePage:!1,title:"Receipt Verifier Service",description:"This page explains how to set up a receipt verifier service.",source:"@site/docs/receipt-verifier.md",slug:"/receipt-verifier",permalink:"/docs/receipt-verifier",editUrl:"https://github.com/WICG/webmonetization/tree/master/docs/receipt-verifier.md",version:"current",sidebar_label:"Receipt verifier service",sidebar:"docs",previous:{title:"Start/Stop Monetization",permalink:"/docs/start-stop"},next:{title:"Web Monetization Explainer",permalink:"/docs/explainer"}},p=[{value:"Before you begin",id:"before-you-begin",children:[]},{value:"Receipt verifier service overview",id:"receipt-verifier-service-overview",children:[]},{value:"Install the receipt verifier service package",id:"install-the-receipt-verifier-service-package",children:[]},{value:"Update your Web Monetization meta tag",id:"update-your-web-monetization-meta-tag",children:[]},{value:"Web Monetization revshare generator",id:"web-monetization-revshare-generator",children:[]},{value:"Set up a monetizationprogress event listener",id:"set-up-a-monetizationprogress-event-listener",children:[]}],s={rightToc:p};function l(e){var t=e.components,r=Object(n.a)(e,["components"]);return Object(a.b)("wrapper",Object(i.a)({},s,r,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"This page explains how to set up a receipt verifier service."),Object(a.b)("p",null,"As more creators adopt Web Monetization to serve premium and/or ad-free content, there\u2019s a greater need for reliable payment verification. Web Monetization browser events, like ",Object(a.b)("inlineCode",{parentName:"p"},"monetizationstart"),", are helpful indicators of payment, but can be spoofed by savvy users to access exclusive content without paying."),Object(a.b)("p",null,Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://interledger.org/rfcs/0039-stream-receipts/"}),"Interledger STREAM receipts")," provide payment recipients (such as web monetized site owners) with verifiable proofs of payment. As a payment recipient, you can verify STREAM receipts yourself by setting up your own receipt verifier service or by using a third-party service. You don't need to run your own Interledger connector or SPSP server to verify STREAM receipts."),Object(a.b)("h2",{id:"before-you-begin"},"Before you begin"),Object(a.b)("p",null,"Your Web Monetization receiver (the digital entity receiving payments) must be set up to generate Interledger STREAM receipts. No action is required on your part. GateHub and Uphold already support receipts."),Object(a.b)("h2",{id:"receipt-verifier-service-overview"},"Receipt verifier service overview"),Object(a.b)("p",null,"The receipt verifier service acts as a proxy between the Web Monetization sender and receiver."),Object(a.b)("p",null,"Before a payment is made, the WM sender sends a query to the WM receiver. The query passes through the receipt verifier service, which adds a receipt secret and receipt nonce."),Object(a.b)("p",null,"When the WM receiver receives money from the payment, it generates a receipt (which includes a signature generated using the receipt secret) and sends the receipt to the WM sender."),Object(a.b)("p",null,"The site takes the receipt from the Web Monetization events, then submits the receipt to its backend. The backend then submits the receipt to the receipt verifier service so the receipt verifier service can confirm the payment (as only it and the WM receiver know the receipt secret). The receipt verifier service must verify the receipt before accepting the amount as paid."),Object(a.b)("h2",{id:"install-the-receipt-verifier-service-package"},"Install the receipt verifier service package"),Object(a.b)("p",null,"You can get the ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://github.com/coilhq/receipt-verifier"}),"receipt verifier service package")," or run the receipt verifier service as a ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://github.com/coilhq/receipt-verifier/tree/main/config/base"}),"Kubernetes service"),"."),Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Example")),Object(a.b)("p",null,"This example shows Coil's implementation of the receipt verifier service package, which requires Redis. You can write a different implementation that doesn't rely on Redis."),Object(a.b)("pre",null,Object(a.b)("code",Object(i.a)({parentName:"pre"},{}),"npm install\nnpm run-script build\nsudo docker run -p 6379:6379 -d redis\nnpm start\n\ngit clone https://github.com/coilhq/receipt-verifier.git\ncd receipt-verifier\n")),Object(a.b)("h2",{id:"update-your-web-monetization-meta-tag"},"Update your Web Monetization meta tag"),Object(a.b)("p",null,"Typically, a Web Monetization meta tag looks something like this:"),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},'<meta name=\u201cmonetization" content="$wallet.example/alice">')),Object(a.b)("p",null,"For queries from the WM sender to be proxied by the receipt verifier service to your payment pointer:"),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},"URI-encode your payment pointer. See ",Object(a.b)("a",Object(i.a)({parentName:"li"},{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent"}),"encodeURIComponent()")," on MDN Web Docs if you need help."),Object(a.b)("li",{parentName:"ol"},"Add your pointer to the path of the receipt verifier service's URL."),Object(a.b)("li",{parentName:"ol"},"Update your meta tag's ",Object(a.b)("inlineCode",{parentName:"li"},"content")," to be this new value.")),Object(a.b)("p",null,"For example, if your payment pointer is ",Object(a.b)("inlineCode",{parentName:"p"},"$wallet.example/alice")," and your receipt verifier service\u2019s URL is ",Object(a.b)("inlineCode",{parentName:"p"},"https://receipt-verifier.example"),", then you\u2019ll set your meta tag\u2019s ",Object(a.b)("inlineCode",{parentName:"p"},"content")," to either of the following:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"https://receipt-verifier.example/%24wallet.example%2Falice")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"$receipt-verifier.example/%24wallet.example%2Falice"))),Object(a.b)("h2",{id:"web-monetization-revshare-generator"},"Web Monetization revshare generator"),Object(a.b)("p",null,"If you used the ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://webmonetization.org/prob-revshare"}),"Web Monetization revshare generator")," to create a meta tag for ",Object(a.b)("a",Object(i.a)({parentName:"p"},{href:"https://webmonetization.org/docs/probabilistic-rev-sharing/"}),"probabilistic revenue sharing"),", follow the same instructions as above: URI-encode your revshare payment pointer and put it in the path of the receipt verifier service\u2019s URL."),Object(a.b)("p",null,"For example, if your meta tag looks like this:"),Object(a.b)("p",null,Object(a.b)("inlineCode",{parentName:"p"},'<meta name="monetization" content="$webmonetization.org/api/revshare/pay/W1siJHdhbGxldC5leGFtcGxlL2FsaWNlIiwxMCwiQWxpY2UiXSxbIiR3YWxsZXQuZXhhbXBsZS9ib2IiLDEwLCJCb2IiXV0">')),Object(a.b)("p",null,"And your receipt verifier service\u2019s URL is ",Object(a.b)("inlineCode",{parentName:"p"},"https://receipt-verifier.example"),", then you\u2019ll set your meta tag\u2019s ",Object(a.b)("inlineCode",{parentName:"p"},"content")," to either of the following:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"https://receipt-verifier.example/%24webmonetization.org%2Fapi%2Frevshare%2Fpay%2FW1siJHdhbGxldC5leGFtcGxlL2FsaWNlIiwxMCwiQWxpY2UiXSxbIiR3YWxsZXQuZXhhbXBsZS9ib2IiLDEwLCJCb2IiXV0")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"$receipt-verifier.example/ %24webmonetization.org%2Fapi%2Frevshare%2Fpay%2FW1siJHdhbGxldC5leGFtcGxlL2FsaWNlIiwxMCwiQWxpY2UiXSxbIiR3YWxsZXQuZXhhbXBsZS9ib2IiLDEwLCJCb2IiXV0"))),Object(a.b)("h2",{id:"set-up-a-monetizationprogress-event-listener"},"Set up a monetizationprogress event listener"),Object(a.b)("p",null,"When a WM sender receives a receipt, the sender notifies the user agent of the successful payment by submitting a ",Object(a.b)("inlineCode",{parentName:"p"},"monetizationprogress")," event containing a receipt."),Object(a.b)("p",null,"Add the following client-side code to your website to listen for a ",Object(a.b)("inlineCode",{parentName:"p"},"monetizationprogress")," event containing a ",Object(a.b)("inlineCode",{parentName:"p"},"receipt"),". When a receipt exists, your website will verify the receipt in the event listener to confirm the payment."),Object(a.b)("pre",null,Object(a.b)("code",Object(i.a)({parentName:"pre"},{className:"language-html"}),"<head>\n  \x3c!-- This should be set to .... --\x3e\n  <meta name=\"monetization\" content=\"https://receipt-verifier.example/%24wallet.example%2Falice\">\n  <script>\n    if (document.monetization) {\n        document.monetization.addEventListener('monetizationprogress', event => {\n            // A payment has been received.\n\n            // Connect to your site\u2019s backend to validate the payment. This does NOT connect directly to the receipt verifier.\n            const res = await fetch('/verifyReceipt', {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json'\n              },\n              body: JSON.stringify({\n                receipt: event.detail.receipt\n              })\n            })\n        })\n    }\n  <\/script>\n</head>\n")),Object(a.b)("p",null,"Your backend can send the receipt to the receipt verifier service\u2019s ",Object(a.b)("inlineCode",{parentName:"p"},"/verify")," endpoint. Here\u2019s an example for an Express.js server:"),Object(a.b)("pre",null,Object(a.b)("code",Object(i.a)({parentName:"pre"},{className:"language-javascript"}),"app.post('/verifyReceipt', async (req, res) => {\n  const resp = await fetch('https://receipt-verifier.example/verify', {\n    method: 'POST',\n    body: req.body.receipt\n  }\n  const { amount } = await resp.json()\n  console.log('Received ' + amount)\n  // backend logic for new paid amount\n})\n")),Object(a.b)("p",null,"The receipt verifier service can confirm the payment, as only the receipt verifier service and the WM receiver know the receipt secret. The receipt verifier service must verify the receipt before accepting the receipt amount as paid. When accepted as paid, the site backend can serve exclusive content or any other perks you\u2019ve set up."))}l.isMDXComponent=!0},92:function(e,t,r){"use strict";r.d(t,"a",(function(){return b})),r.d(t,"b",(function(){return d}));var i=r(0),n=r.n(i);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function p(e,t){if(null==e)return{};var r,i,n=function(e,t){if(null==e)return{};var r,i,n={},a=Object.keys(e);for(i=0;i<a.length;i++)r=a[i],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)r=a[i],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var s=n.a.createContext({}),l=function(e){var t=n.a.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):c(c({},t),e)),r},b=function(e){var t=l(e.components);return n.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.a.createElement(n.a.Fragment,{},t)}},m=n.a.forwardRef((function(e,t){var r=e.components,i=e.mdxType,a=e.originalType,o=e.parentName,s=p(e,["components","mdxType","originalType","parentName"]),b=l(r),m=i,d=b["".concat(o,".").concat(m)]||b[m]||u[m]||a;return r?n.a.createElement(d,c(c({ref:t},s),{},{components:r})):n.a.createElement(d,c({ref:t},s))}));function d(e,t){var r=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=r.length,o=new Array(a);o[0]=m;var c={};for(var p in t)hasOwnProperty.call(t,p)&&(c[p]=t[p]);c.originalType=e,c.mdxType="string"==typeof e?e:i,o[1]=c;for(var s=2;s<a;s++)o[s]=r[s];return n.a.createElement.apply(null,o)}return n.a.createElement.apply(null,r)}m.displayName="MDXCreateElement"}}]);